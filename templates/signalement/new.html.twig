{% extends 'base.html.twig' %}

{% block title %}Signaler un probl√®me{% endblock %}

{% block body %}
    <div class="container my-5" style="max-width: 700px;">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-body p-5">
                <h1 class="text-center mb-4 fw-bold text-danger">üìç Signaler ma position</h1>

                <p class="lead text-center text-muted">
                    Pour que nous puissions traiter votre signalement avec efficacit√©,<br>merci d‚Äôautoriser l‚Äôacc√®s √† votre position.
                </p>

                <div class="alert alert-info border-0 rounded-3 shadow-sm">
                    <strong>Pourquoi c‚Äôest important ?</strong>
                    <ul class="mb-0">
                        <li>üìå Localisation rapide et pr√©cise</li>
                        <li>‚úçÔ∏è Aucune saisie manuelle n√©cessaire</li>
                        <li>‚è±Ô∏è Traitement prioritaire de votre signalement</li>
                    </ul>
                </div>

                <div class="text-center my-4">
                    <button class="btn btn-danger btn-lg px-4" onclick="getLocation()" id="locate-btn">
                        üì° Activer la localisation
                    </button>
                    <div id="result" class="mt-3 fw-bold text-success"></div>
                    <div id="spinner" class="text-center mt-2" style="display: none;">
                        <div class="spinner-border text-secondary" role="status"></div>
                    </div>
                </div>

                {{ form_start(form) }}

                <div class="row g-3" style="display: none">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Latitude</label>
                        <div class="input-group">
                            <span class="input-group-text">üß≠</span>
                            {{ form_widget(form.latitude, {'attr': {'class': 'form-control'}}) }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Longitude</label>
                        <div class="input-group">
                            <span class="input-group-text">üß≠</span>
                            {{ form_widget(form.longitude, {'attr': {'class': 'form-control'}}) }}
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-semibold d-block">{{ form_label(form.type) }}</label>

                    {# On construit un ¬´ btn-group ¬ª responsive #}
                    <div class="btn-group flex-wrap" role="group" aria-label="Type de probl√®me">
                        {% for choice in form.type %}
                            {# L‚Äôinput radio invisible (btn-check) #}
                            {{ form_widget(choice, {
                                'attr': {
                                    'class': 'btn-check',
                                    'autocomplete': 'off'
                                }
                            }) }}

                            {# Le label styl√© comme un bouton Bootstrap #}
                            <label class="btn btn-outline-primary me-2 mb-2" for="{{ choice.vars.id }}">
                                {{ choice.vars.label }}
                            </label>
                        {% endfor %}
                    </div>

                    {{ form_errors(form.type) }}
                </div>

                <div class="mt-4">
                    <label class="form-label fw-semibold">Description du probl√®me</label>
                    {{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': 4}}) }}
                </div>

                <div class="text-end mt-4">
                    <button class="btn btn-success btn-lg px-4">
                        üöÄ Envoyer le signalement
                    </button>
                </div>

                {{ form_end(form) }}
            </div>
        </div>
    </div>

    <script>
        function getLocation () {
            const result    = document.getElementById('result');
            const spinner   = document.getElementById('spinner');
            const locateBtn = document.getElementById('locate-btn');

            result.textContent  = '';
            spinner.style.display = 'block';

            locateBtn.disabled = true;                 // √©vite les doubles clics
            locateBtn.classList.remove('btn-success'); // on repart d'une base neutre
            locateBtn.classList.add('btn-danger');
            locateBtn.innerHTML = 'üì° Recherche en cours‚Ä¶';

            if (!navigator.geolocation) {
                result.textContent = '‚ùå Votre navigateur ne supporte pas la g√©olocalisation.';
                resetButton();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function (position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // Affichage de la position


                    // Remplit les champs cach√©s du formulaire
                    document.getElementById('{{ form.latitude.vars.id }}').value = lat;
                    document.getElementById('{{ form.longitude.vars.id }}').value = lon;

                    // --- Mise √† jour du bouton ---
                    spinner.style.display = 'none';
                    locateBtn.disabled = true;                      // on le fige
                    locateBtn.classList.remove('btn-danger');
                    locateBtn.classList.add('btn-success');
                    locateBtn.innerHTML = '‚úÖ Localisation r√©cup√©r√©e';
                },
                function (error) {
                    let msg;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            msg = '‚ö†Ô∏è Autorisation refus√©e. Merci d‚Äôaccepter la g√©olocalisation.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            msg = '‚ö†Ô∏è Position indisponible.';
                            break;
                        case error.TIMEOUT:
                            msg = '‚ö†Ô∏è D√©lai d√©pass√©. Veuillez r√©essayer.';
                            break;
                        default:
                            msg = '‚ö†Ô∏è Erreur inconnue.';
                    }
                    result.textContent = msg;
                    resetButton();
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );

            // Remet le bouton √† son √©tat initial (rouge) apr√®s une erreur
            function resetButton () {
                spinner.style.display = 'none';
                locateBtn.disabled = false;
                locateBtn.classList.remove('btn-success');
                locateBtn.classList.add('btn-danger');
                locateBtn.innerHTML = 'üì° Activer la localisation';
            }
        }

        // D√©clenche automatiquement √† l‚Äôouverture de la page
        document.addEventListener('DOMContentLoaded', () => getLocation());
    </script>

{% endblock %}
